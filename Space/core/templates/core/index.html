<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Спутниковые снимки</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: white;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .product-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .product-btn.active {
            box-shadow: 0 0 0 2px #007bff;
        }

        .date-selector {
            text-align: center;
            margin: 20px 0;
        }

        .date-selector select {
            padding: 10px;
            font-size: 16px;
            min-width: 200px;
        }

        .image-container {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }

        .preview-image {
            max-width: 100%;
            max-height: 600px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .info {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            text-align: center;
        }

        .download-btn {
            display: inline-block;
            margin-top: 15px;
            padding: 10px 20px;
            background: #28a745;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
        }

        .download-btn:hover {
            background: #218838;
        }

        .status {
            padding: 15px;
            margin: 20px auto;
            max-width: 800px;
            text-align: center;
            border-radius: 5px;
        }

        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Спутниковые снимки Sentinel-2</h1>
        <p>Просмотр снимков за разные даты</p>
    </div>

    <div class="controls">
        <button class="product-btn active" data-product="TCI" style="background: #007bff; color: white;">
            Естественные цвета
        </button>
        <button class="product-btn" data-product="NDVI" style="background: #28a745; color: white;">
            NDVI
        </button>
        <button class="product-btn" data-product="NDWI" style="background: #17a2b8; color: white;">
            NDWI
        </button>
        <button class="product-btn" data-product="ALL" style="background: #6c757d; color: white;">
            Все даты
        </button>
    </div>

    <div class="date-selector">
        <label for="date-select">Выберите дату: </label>
        <select id="date-select">
            <option value="">Загрузка дат...</option>
        </select>
    </div>

    <div class="image-container">
        <div id="loading" style="display: none;">
            <p>Загрузка изображения...</p>
        </div>

        <img id="preview-image" class="preview-image" src="" alt="Превью снимка" style="display: none;">

        <div id="no-image" class="status info">
            Выберите дату для отображения снимка
        </div>

        <div id="error-message" class="status error" style="display: none;">
            Ошибка загрузки изображения
        </div>
    </div>

    <div class="info">
        <p><strong>Тайл:</strong> <span id="image-tile">-</span></p>
        <p><strong>Дата:</strong> <span id="image-date">-</span></p>
        <p><strong>Тип продукта:</strong> <span id="image-product-type">TCI</span></p>

        <a id="download-btn" class="download-btn" href="#" download style="display: none;">
            Скачать продукт
        </a>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        let currentProduct = 'TCI';

        // Обработчики кнопок продуктов
        document.querySelectorAll('.product-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.product-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                currentProduct = this.dataset.product;
                document.getElementById('image-product-type').textContent = currentProduct;

                loadAvailableDates(currentProduct);
            });
        });

        // Обработчик выбора даты
        const dateSelect = document.getElementById('date-select');
        dateSelect.addEventListener('change', function() {
            const selectedDate = this.value;
            if (selectedDate) {
                loadImageForDate(selectedDate, currentProduct);
            }
        });

        // Загрузка начальных данных
        loadAvailableDates('TCI');
    });

    async function loadAvailableDates(productType) {
        const dateSelect = document.getElementById('date-select');
        dateSelect.innerHTML = '<option value="">Загрузка...</option>';

        try {
            const response = await fetch(`/api/available-dates/?product=${productType}`);
            const data = await response.json();

            if (data.dates && data.dates.length > 0) {
                dateSelect.innerHTML = '<option value="">Выберите дату</option>';

                data.dates.forEach(date => {
                    const option = document.createElement('option');
                    option.value = date;
                    option.textContent = formatDate(date);
                    dateSelect.appendChild(option);
                });

                // Автоматически выбираем последнюю дату
                if (data.dates.length > 0) {
                    dateSelect.value = data.dates[0];
                    loadImageForDate(data.dates[0], productType);
                }
            } else {
                dateSelect.innerHTML = '<option value="">Нет доступных дат</option>';
                showNoImage('Нет доступных снимков для выбранного продукта');
            }
        } catch (error) {
            console.error('Error loading dates:', error);
            dateSelect.innerHTML = '<option value="">Ошибка загрузки</option>';
            showError('Ошибка загрузки списка дат');
        }
    }

    async function loadImageForDate(dateStr, productType) {
        showLoading();

        try {
            const response = await fetch(`/api/image-for-date/?date=${dateStr}&product=${productType}`);
            const data = await response.json();

            if (!data.error && data.preview_url) {
                displayImage(data);
            } else {
                showNoImage(data.error || 'Изображение не найдено');
            }
        } catch (error) {
            console.error('Error loading image:', error);
            showError('Ошибка загрузки изображения');
        }
    }

    function displayImage(data) {
        const previewImage = document.getElementById('preview-image');
        const noImage = document.getElementById('no-image');
        const errorMessage = document.getElementById('error-message');
        const downloadBtn = document.getElementById('download-btn');
        const loading = document.getElementById('loading');

        // Скрываем все статусы
        if (loading) loading.style.display = 'none';
        if (noImage) noImage.style.display = 'none';
        if (errorMessage) errorMessage.style.display = 'none';

        // Показываем изображение
        if (previewImage) {
            previewImage.src = data.preview_url;
            previewImage.style.display = 'block';
            previewImage.onerror = function() {
                showError('Ошибка загрузки изображения с сервера');
            };
        }

        // Обновляем информацию
        document.getElementById('image-tile').textContent = data.tile || '-';
        document.getElementById('image-date').textContent = data.date || '-';

        // Настраиваем кнопку скачивания
        if (downloadBtn && data.download_url) {
            downloadBtn.href = data.download_url;
            downloadBtn.style.display = 'inline-block';
        } else if (downloadBtn) {
            downloadBtn.style.display = 'none';
        }
    }

    function showLoading() {
        const previewImage = document.getElementById('preview-image');
        const noImage = document.getElementById('no-image');
        const errorMessage = document.getElementById('error-message');
        const loading = document.getElementById('loading');
        const downloadBtn = document.getElementById('download-btn');

        if (previewImage) previewImage.style.display = 'none';
        if (noImage) noImage.style.display = 'none';
        if (errorMessage) errorMessage.style.display = 'none';
        if (loading) loading.style.display = 'block';
        if (downloadBtn) downloadBtn.style.display = 'none';
    }

    function showNoImage(message) {
        const previewImage = document.getElementById('preview-image');
        const noImage = document.getElementById('no-image');
        const errorMessage = document.getElementById('error-message');
        const loading = document.getElementById('loading');
        const downloadBtn = document.getElementById('download-btn');

        if (previewImage) previewImage.style.display = 'none';
        if (loading) loading.style.display = 'none';
        if (errorMessage) errorMessage.style.display = 'none';
        if (noImage) {
            noImage.textContent = message;
            noImage.style.display = 'block';
        }
        if (downloadBtn) downloadBtn.style.display = 'none';
    }

    function showError(message) {
        const previewImage = document.getElementById('preview-image');
        const noImage = document.getElementById('no-image');
        const errorMessage = document.getElementById('error-message');
        const loading = document.getElementById('loading');
        const downloadBtn = document.getElementById('download-btn');

        if (previewImage) previewImage.style.display = 'none';
        if (loading) loading.style.display = 'none';
        if (noImage) noImage.style.display = 'none';
        if (errorMessage) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }
        if (downloadBtn) downloadBtn.style.display = 'none';
    }

    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('ru-RU');
    }
    </script>
</body>
</html>